<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title></title>
</head>

<body>
  <script>
    // var x = 1;

    // function* foo() {
    //   x++;
    //   yield; // 暂停！
    //   console.log("x:", x);
    // }

    // function bar() {
    //   x++;
    // }

    // // 构造一个迭代器it来控制这个生成器
    // var it = foo();

    // // 这里启动foo()！
    // it.next();
    // x; // 2
    // bar();
    // x; // 3
    // it.next(); // x: 3
    // // console.log(it);

    // function* foo(x) {
    //   var y = x * (yield '函数的值');
    //   // return y;
    //   return undefined;
    // }

    // var it = foo(10);
    // console.log(it.next(11));
    // // 启动foo(..)
    // // it.next();

    // var res = it.next(7);
    // console.log(res);

    // res.value; // 42

    // var a = 1;
    // var b = 2;

    // function* foo() {
    //   console.log('1');
    //   a++;
    //   yield;
    //   console.log('3');
    //   b = b * a;
    //   a = (yield b) + 3;
    // }

    // function* bar() {
    //   console.log('2');
    //   b--;
    //   yield;
    //   a = (yield 8) + b;
    //   b = a * (yield 2);
    // }

    // function step(gen) {
    //   var it = gen();
    //   var last;

    //   return function () {
    //     // 不管yield出来的是什么，下一次都把它原样传回去！
    //     last = it.next(last).value;
    //   };
    // }

    // var s1 = step(foo);
    // var s2 = step(bar);

    // // console.log(s1);

    // // 首次运行*foo()
    // s1();
    // s1();
    // s1();

    // // 现在运行*bar()
    // s2();
    // s2();
    // s2();
    // s2();

    // console.log(a, b); // 11 22


    // var gimmeSomething = (function () {
    //   var nextVal;

    //   return function () {
    //     if (nextVal === undefined) {
    //       nextVal = 1;
    //     } else {
    //       nextVal = (3 * nextVal) + 6;
    //     }

    //     return nextVal;
    //   };
    // })();

    // gimmeSomething(); // 1
    // gimmeSomething(); // 9
    // gimmeSomething(); // 33
    // gimmeSomething(); // 105

    // var something = (function () {
    //   var nextVal;

    //   return {
    //     // for..of循环需要
    //     [Symbol.iterator]: function () {
    //       return this;
    //     },

    //     // 标准迭代器接口方法
    //     next: function () {
    //       if (nextVal === undefined) {
    //         nextVal = 1;
    //       } else {
    //         nextVal = (3 * nextVal) + 6;
    //       }

    //       return {
    //         done: false,
    //         value: nextVal
    //       };
    //     }
    //   };
    // })();
    // something.next().value; // 1
    // something.next().value; // 9
    // something.next().value; // 33
    // something.next().value; // 105

    // function* something() {
    //   try {
    //     var nextVal;

    //     while (true) {
    //       if (nextVal === undefined) {
    //         nextVal = 1;
    //       } else {
    //         nextVal = (3 * nextVal) + 6;
    //       }

    //       yield nextVal;
    //     }
    //   }
    //   // 清理子句
    //   finally {
    //     console.log("cleaning up!");
    //   }
    // }

    // var it = something();
    // for (var v of it) {
    //   console.log(v);

    //   // 不要死循环！
    //   if (v > 500) {
    //     console.log(
    //       // 完成生成器的迭代器
    //       it.return("Hello World").value
    //     );
    //     // 这里不需要break
    //   }
    // }
    // // 1 9 33 105 321 969
    // // 清理！
    // // Hello World

    // function foo(x, y) {
    //   // console.log(it);
    //   ajax(
    //     "http://some.url.1/?x=" + x + "&y=" + y,
    //     function (err, data) {
    //       if (err) {
    //         // 向*main()抛出一个错误
    //         it.throw(err);
    //       } else {
    //         // 用收到的data恢复*main()
    //         it.next(data);
    //       }
    //     }
    //   );
    // }

    // function* main() {
    //   console.log(it);
    //   console.log(this);//window
    //   try {
    //     var text = yield foo(11, 31);
    //     console.log(text);
    //   } catch (err) {
    //     console.error(err);
    //   }
    // }

    // var it = main();

    // // 这里启动！
    // it.next();

    // function foo(x, y) {
    //   return request(
    //     "http://some.url.1/?x=" + x + "&y=" + y
    //   );
    // }

    // foo(11, 31)
    //   .then(
    //     function (text) {
    //       console.log(text);
    //     },
    //     function (err) {
    //       console.error(err);
    //     }
    //   );

    // function foo(x, y) {
    //   return request(
    //     "http://some.url.1/?x=" + x + "&y=" + y
    //   );
    // }

    // function* main() {
    //   try {
    //     var text = yield foo(11, 31);
    //     console.log(text);
    //   } catch (err) {
    //     console.error(err);
    //   }
    // }
    // var it = main();

    // var p = it.next().value;

    // // 等待promise p决议
    // p.then(
    //   function (text) {
    //     it.next(text);
    //   },

    //   function (err) {
    //     it.throw(err);
    //   }
    // );
    // var a = {
    //   index: 1
    // };

    // // 然后
    // console.log(a); // ??

    // // 再然后
    // a.index++;
    // console.log(a);
    // function foo(x, y) {
    //   ajax(
    //     "http://some.url.1/?x=" + x + "&y=" + y,
    //     function (err, data) {
    //       if (err) {
    //         // 向*main()抛出一个错误
    //         it.throw(err);
    //       } else {
    //         // 用收到的data恢复*main()
    //         it.next(data);
    //       }
    //     }
    //   );
    // }

    // function* main() {
    //   console.log(it);
    //   try {
    //     var text = yield foo(11, 31);
    //     console.log(text);
    //   } catch (err) {
    //     console.error(err);
    //   }
    // }

    // var it = main();

    // // 这里启动！
    // it.next();


    // function foo(x, y) {
    //   return request(
    //     "http://some.url.1/?x=" + x + "&y=" + y
    //   );
    // }

    // function* main() {
    //   try {
    //     var text = yield foo(11, 31);
    //     console.log(text);
    //   } catch (err) {
    //     console.error(err);
    //   }
    // }

    // var it = main();

    // var p = it.next().value;

    // // 等待promise p决议
    // p.then(
    //   function (text) {
    //     it.next(text);
    //   },

    //   function (err) {
    //     it.throw(err);
    //   }
    // );

    // 在此感谢Benjamin Gruenbaum （@benjamingr on GitHub）的巨大改进！
    function run(gen) {
      var args = [].slice.call(arguments, 1),
        it;

      // 在当前上下文中初始化生成器
      it = gen.apply(this, args);

      // 返回一个promise用于生成器完成
      return Promise.resolve()
        .then(function handleNext(value) {
          console.log(value);
          // 对下一个yield出的值运行
          var next = it.next(value);

          return (function handleResult(next) {
            // 生成器运行完毕了吗？
            if (next.done) {
              return next.value;
            }
            // 否则继续运行
            else {
              return Promise.resolve(next.value)
                .then(
                  // 成功就恢复异步循环，把决议的值发回生成器
                  handleNext,

                  // 如果value是被拒绝的 promise，
                  // 就把错误传回生成器进行出错处理
                  function handleErr(err) {
                    return Promise.resolve(
                        it.throw(err)
                      )
                      .then(handleResult);
                  }
                );
            }
          })(next);
        });
    }



    function* foo() {
      var r1 = yield request("http://some.url.1");
      var r2 = yield request("http://some.url.2");

      var r3 = yield request(
        "http://some.url.3/?v=" + r1 + "," + r2
      );

      console.log(r3);
    }

    // 使用前面定义的工具run(..)
    run(foo);
  </script>
</body>
































<script>
</script>

</html>